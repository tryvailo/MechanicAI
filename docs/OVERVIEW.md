# MechanicAI — Обзор продукта

> AI-приложение для диагностики автомобилей: фото проблемы → AI анализ → рекомендации → поиск сервисов

---

## 1. Текущая реализация

### 1.1 Высокоуровневая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                        👤 Пользователь                          │
│         📷 Фото    🎥 Видео    🎤 Голос    📍 Геолокация         │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     📱 Next.js PWA (Frontend)                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ │
│  │  Камера  │ │ Результат│ │   Чат    │ │ История  │ │ Карта  │ │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ⚙️ Vercel Serverless API                      │
│  ┌────────────────┐ ┌────────────┐ ┌───────────────────────────┐│
│  │/api/analyze-   │ │ /api/chat  │ │ /api/nearby-places        ││
│  │     photo      │ │            │ │ /api/transcribe-gemini    ││
│  └────────────────┘ └────────────┘ └───────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
┌───────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  🤖 OpenAI        │ │  🤖 Gemini 2.0  │ │  🗺️ Google      │
│  GPT-4o Vision    │ │  Flash Realtime │ │  Places + Maps  │
│  (фото + чат)     │ │  (видео + голос)│ │  (сервисы)      │
└───────────────────┘ └─────────────────┘ └─────────────────┘
```

### 1.2 Основные блоки

| Блок | Технология | Функция |
|------|------------|---------|
| **Frontend** | Next.js 16 + React 19 | PWA: камера, чат, карта, история |
| **Photo Analysis** | OpenAI GPT-4o Vision | Анализ фото проблем авто |
| **Realtime Video** | Gemini 2.0 Flash (WebSocket) | Live видео-диагностика с голосом |
| **Voice Input** | Gemini + Whisper (fallback) | Транскрипция голосовых сообщений |
| **Maps & Places** | Google Maps + Places API | Поиск автосервисов рядом |
| **Storage** | localStorage | История сканирований (временно) |

### 1.3 Пользовательский флоу

```
📷 Фото проблемы
      │
      ▼
🔍 AI анализ (OpenAI Vision)
      │
      ▼
📋 Диагноз + рекомендации
      │
      ├──────────────────┐
      ▼                  ▼
💬 Чат с AI         📍 Найти сервис
   (уточнения)         (Google Places)
```

### 1.4 Планируемые функции (TODO)

| Функция | Интеграция | Статус |
|---------|------------|--------|
| Поиск запчастей | AutoDoc API | 🔜 Планируется |
| Проверка совместимости | AutoDoc API | 🔜 Планируется |
| Рекомендации запчастей | AI + База данных | 🔜 Планируется |

---

## 2. Что нужно для продакшена

### 2.1 Миграция Vercel → Google Cloud

```
┌─────────────────────────────────────────────────────────────────┐
│                    ☁️ Google Cloud Platform                      │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Cloud Run     │  │ Secret Manager  │  │  Cloud Build    │ │
│  │   (API сервис)  │  │   (ключи API)   │  │   (CI/CD)       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐                      │
│  │ Firebase Auth   │  │ Cloud Logging   │                      │
│  │ (авторизация)   │  │ (мониторинг)    │                      │
│  └─────────────────┘  └─────────────────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

#### Маппинг компонентов

| Vercel (сейчас) | Google Cloud (цель) |
|-----------------|---------------------|
| Vercel Functions | **Cloud Run** |
| Vercel Env Variables | **Secret Manager** |
| Vercel Git Deploy | **Cloud Build** |
| — | **Firebase Auth** (новое) |

#### Задачи миграции

| # | Задача | Сложность |
|---|--------|-----------|
| 1 | Создать Dockerfile | 🟢 Низкая |
| 2 | Настроить Cloud Run | 🟢 Низкая |
| 3 | Перенести secrets в Secret Manager | 🟢 Низкая |
| 4 | Настроить Cloud Build (CI/CD) | 🟡 Средняя |
| 5 | Подключить домен + SSL | 🟢 Низкая |
| 6 | Тестирование | 🟢 Низкая |

---

### 2.2 Интеграция в мобильные приложения

#### Архитектура интеграции

```
┌─────────────────────────────────────────────────────────────────┐
│                    📱 Мобильные приложения                       │
│                                                                 │
│  ┌─────────────────────┐       ┌─────────────────────┐         │
│  │      iOS App        │       │    Android App      │         │
│  │      (Swift)        │       │     (Kotlin)        │         │
│  │                     │       │                     │         │
│  │  ┌───────────────┐  │       │  ┌───────────────┐  │         │
│  │  │ Нативная      │  │       │  │ Нативная      │  │         │
│  │  │ камера        │  │       │  │ камера        │  │         │
│  │  └───────────────┘  │       │  └───────────────┘  │         │
│  │  ┌───────────────┐  │       │  ┌───────────────┐  │         │
│  │  │ HTTP Client   │  │       │  │ HTTP Client   │  │         │
│  │  │ (URLSession)  │  │       │  │ (Retrofit)    │  │         │
│  │  └───────────────┘  │       │  └───────────────┘  │         │
│  │  ┌───────────────┐  │       │  ┌───────────────┐  │         │
│  │  │ WebSocket     │  │       │  │ WebSocket     │  │         │
│  │  │ (опционально) │  │       │  │ (опционально) │  │         │
│  │  └───────────────┘  │       │  └───────────────┘  │         │
│  └─────────────────────┘       └─────────────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      ☁️ Cloud Run API                            │
│                                                                 │
│   POST /api/analyze-photo    ←  base64 изображение              │
│   POST /api/chat             ←  массив сообщений                │
│   POST /api/nearby-places    ←  координаты                      │
│   POST /api/transcribe-gemini ← аудио файл                      │
│                                                                 │
│   WSS  Gemini Realtime       ←  видео кадры (WebSocket)         │
└─────────────────────────────────────────────────────────────────┘
```

#### API контракт для мобильных приложений

| Endpoint | Request | Response |
|----------|---------|----------|
| `POST /api/analyze-photo` | `{ image: "base64...", prompt?: "..." }` | `{ diagnosis, recommendations }` |
| `POST /api/chat` | `{ messages: [...], context?: {...} }` | SSE stream |
| `POST /api/nearby-places` | `{ lat, lng, radius? }` | `{ carRepairs, parkings }` |

#### Задачи интеграции

| # | Задача | Платформа | Сложность |
|---|--------|-----------|-----------|
| 1 | Адаптация API (CORS, auth) | Backend | 🟢 Низкая |
| 2 | Камера → base64 → API | iOS | 🟡 Средняя |
| 3 | Камера → base64 → API | Android | 🟡 Средняя |
| 4 | UI отображения результатов | iOS / Android | 🟡 Средняя |
| 5 | Чат интерфейс (SSE) | iOS / Android | 🟡 Средняя |
| 6 | WebSocket для Gemini Realtime | iOS / Android | 🟡 Средняя |

---

## 3. Необходимые ресурсы

| Роль | Задачи |
|------|--------|
| **Backend/DevOps** | Cloud Run миграция, CI/CD, Secret Manager |
| **iOS разработчик** | Интеграция API, камера, UI |
| **Android разработчик** | Интеграция API, камера, UI |

### Риски

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Задержка мобильной разработки | Средняя | Параллельная работа iOS/Android |
| Проблемы с WebSocket на мобильных | Средняя | MVP без realtime, добавить позже |
| Лимиты Google Cloud | Низкая | Мониторинг + алерты |

---

## 4. Визуальная схема

Интерактивная диаграмма: **[docs/OVERVIEW.html](./OVERVIEW.html)** — открыть в браузере
